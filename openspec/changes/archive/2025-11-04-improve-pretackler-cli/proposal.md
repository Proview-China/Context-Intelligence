# 变更提案：完善 PreTackler 能力（保持向后兼容）

## Why
现有 PreTackler 仅支持基础命令（`pretackler <INPUT> --version <v>`）。为满足真实项目大规模摘要、稳定性与可观测性需求，需要：参数化 Prompt 与模型、流式输出、并发与限速控制、超时与重试、I/O 幂等、跳过策略、详尽日志、安全密钥加载与完善中文文档。

## 背景与动机
现有 PreTackler 仅支持基础命令（`pretackler <INPUT> --version <v>`）。为满足真实项目大规模摘要、稳定性与可观测性需求，需要：参数化 Prompt 与模型、流式输出、并发与限速控制、超时与重试、I/O 幂等、跳过策略、详尽日志、安全密钥加载与完善中文文档。

## 目标
- 保持向后兼容，新增能力均为可选，默认值合理。
- 增加：Prompt 模板、模型与采样（流式）、自适应并发与上限、（可选）令牌桶限速、超时与重试（指数退避）、I/O 幂等与临时文件、跳过策略、日志与可观测性、密钥安全加载、中文 README 与验收方法。

## What Changes
- CLI 新增参数：`--prompt`、`--model`、`--temperature`、`--top-k`、`--concurrency-ceil`、`--skip-*`、`--connect-timeout`、`--request-timeout`、`--stream-idle-timeout`、`--rate-limit-*`、`--verbose`。
- Processor 增强：流式 data: 解析、指数退避重试、空闲超时、临时文件原子落盘、跳过策略、并发估算与上限裁剪、可选令牌桶限速、日志细化。
- 安全：密钥加载顺序与脱敏日志。
- 文档：新增中文 README（参数表、示例与故障建议）。

## 非目标
- 不引入重量级依赖或外部服务（除现有 DeepSeek 调用）。
- 不改变现有输出的业务结构，仅增强过程能力与稳定性。

## 影响面
- CLI 入口：增加多项参数（均带中文 help）。
- 处理流程：引入并发估算、重试策略、空闲检测、临时文件写入与原子落盘。
- 文档：新增中文 README 章节与示例。

## 风险与缓解
- 高并发导致限速/429：提供并发上限、令牌桶与退避重试。
- 网络抖动导致长时间阻塞：引入 `stream-idle-timeout` 与快速失败重试。
- 临时文件残留：WriterGuard 失败/中断清理，保证幂等。

## 验收
- 小目录与 >1000 文件目录各跑一次，记录：总耗时、成功率、重试次数。
- 人为制造 429/5xx/网络抖动/idle 超时，可被快速感知与重试，其他文件不受阻塞。

## 里程碑
- M1：Prompt/模型采样/并发上限/临时文件/基础日志/密钥顺序/跳过策略。
- M2：指数退避重试 + 空闲超时 + 观测增强 + 自适应并发。
- M3：令牌桶限速 + 简易网络采样回退逻辑。
